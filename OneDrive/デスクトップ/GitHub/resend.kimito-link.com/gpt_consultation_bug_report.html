<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail API 403ã‚¨ãƒ©ãƒ¼ - GPTç›¸è«‡ç”¨ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #d32f2f;
            border-bottom: 3px solid #d32f2f;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h2 {
            color: #1976d2;
            margin-top: 30px;
            margin-bottom: 15px;
            border-left: 4px solid #1976d2;
            padding-left: 10px;
        }
        h3 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .error-box {
            background: #ffebee;
            border-left: 4px solid #d32f2f;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .code-block {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 13px;
            line-height: 1.5;
            margin: 10px 0;
        }
        .code-block code {
            color: #d32f2f;
        }
        .file-path {
            color: #1976d2;
            font-weight: bold;
            font-family: monospace;
        }
        .line-number {
            color: #666;
            font-size: 12px;
        }
        ul, ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        li {
            margin: 5px 0;
        }
        .copy-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        .copy-btn:hover {
            background: #1565c0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #f5f5f5;
            font-weight: bold;
        }
        .highlight {
            background: #fff9c4;
            padding: 2px 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› Gmail API 403ã‚¨ãƒ©ãƒ¼ - GPTç›¸è«‡ç”¨ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆ</h1>
        
        <div class="error-box">
            <h3>âŒ ã‚¨ãƒ©ãƒ¼æ¦‚è¦</h3>
            <p><strong>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ã€Œæ¨©é™ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚ã€</p>
            <p><strong>HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰:</strong> 403 (PERMISSION_DENIED)</p>
            <p><strong>ç™ºç”Ÿç®‡æ‰€:</strong> <code>/send/execute</code> ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</p>
            <p><strong>ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°:</strong> ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›</p>
        </div>

        <h2>ğŸ“‹ å•é¡Œã®è©³ç´°</h2>
        <div class="info-box">
            <p>Gmail APIã¸ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ403ã‚¨ãƒ©ãƒ¼ï¼ˆæ¨©é™ä¸è¶³ï¼‰ã§å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚</p>
            <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚å–å¾—ã§ãã¦ã„ã‚‹ãŒã€Gmail APIã‹ã‚‰403ãŒè¿”ã£ã¦ãã‚‹çŠ¶æ…‹ã§ã™ã€‚</p>
        </div>

        <h2>ğŸ–¥ï¸ å®Ÿè¡Œç’°å¢ƒ</h2>
        <table>
            <tr>
                <th>é …ç›®</th>
                <th>å€¤</th>
            </tr>
            <tr>
                <td>ã‚µãƒ¼ãƒãƒ¼</td>
                <td>Xã‚µãƒ¼ãƒãƒ¼ï¼ˆsv16.sixcore.ne.jpï¼‰</td>
            </tr>
            <tr>
                <td>PHPãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆWebå®Ÿè¡Œï¼‰</td>
                <td>PHP 8.3.21</td>
            </tr>
            <tr>
                <td>PHPãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆCLIå®Ÿè¡Œï¼‰</td>
                <td>ä¸æ˜ï¼ˆWebå®Ÿè¡Œã¨ç•°ãªã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰</td>
            </tr>
            <tr>
                <td>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹</td>
                <td><code>/home/besttrust/kimito-link.com/_git/mailloop</td>
            </tr>
            <tr>
                <td>URL</td>
                <td><code>https://resend.kimito-link.com</code></td>
            </tr>
        </table>

        <h2>ğŸ” ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿãƒ•ãƒ­ãƒ¼</h2>
        <ol>
            <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹ï¼‰</li>
            <li>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
            <li><code>POST /send/execute</code> ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹</li>
            <li><code>get_google_access_token_or_refresh()</code> ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆæˆåŠŸï¼‰</li>
            <li><code>gmail_send_message()</code> ã§Gmail APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡</li>
            <li><strong>Gmail APIã‹ã‚‰403ã‚¨ãƒ©ãƒ¼ãŒè¿”ã‚‹</strong></li>
            <li>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œæ¨©é™ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹</li>
        </ol>

        <h2>ğŸ’» é–¢é€£ã‚³ãƒ¼ãƒ‰</h2>
        
        <h3>1. é€ä¿¡å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰</h3>
        <p class="file-path">public/index.php (1030-1130è¡Œç›®)</p>
        <div class="code-block">
<pre>route('POST', '/send/execute', function() use ($storage, $config) {
  $u=require_login($storage);
  if (!csrf_verify()) {
    return;
  }
  // ... çœç•¥ ...
  
  // ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆæœŸé™åˆ‡ã‚ŒãŒè¿‘ã‘ã‚Œã°è‡ªå‹•refreshï¼‰
  require_once __DIR__ . '/../app/services/token_manager.php';
  try {
    $access = get_google_access_token_or_refresh($storage, $config, (int)$u['id']);
  } catch (RuntimeException $e) {
    error_log('Token refresh failed in /send/execute: ' . $e->getMessage());
    header('Location: /auth/login?reauth=1');
    exit;
  }
  
  // ... ãƒ¡ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿æº–å‚™ ...
  
  // Gmailé€ä¿¡
  $sendResult = gmail_send_message($access, $mail);
  $sResp = $sendResult[0];
  $sData = $sendResult[1];
  $httpCode = (int)($sResp['code'] ?? 0);
  
  // 401ã®å ´åˆã¯ä¸€åº¦ã ã‘refreshã—ã¦å†è©¦è¡Œ
  if ($httpCode === 401) {
    // ... refreshå‡¦ç† ...
  }
  
  // 403ï¼ˆæ¨©é™ä¸è¶³ï¼‰ã®å ´åˆã¯å†è©¦è¡Œä¸è¦ã€å†èªè¨¼ã¸èª˜å°
  if ($httpCode === 403) {
    $status = 'failed';
    $error = [
      'http_code' => 403,
      'google_error' => [
        'message' => 'æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã¾ã™',
        'status' => 'PERMISSION_DENIED',
      ],
      'when' => date('c'),
    ];
    // ... ãƒ­ã‚°ä¿å­˜ ...
    render_error('æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
});</pre>
        </div>

        <h3>2. Gmailé€ä¿¡é–¢æ•°</h3>
        <p class="file-path">app/services/gmail_send.php (40-48è¡Œç›®)</p>
        <div class="code-block">
<pre>function gmail_send_message(string $accessToken, array $mail): array {
  $raw = build_rfc822($mail);
  $payload = ['raw' => base64url_encode($raw)];
  $resp = http_post_json('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', $payload, [
    'Authorization: Bearer ' . $accessToken
  ]);
  $data = json_decode($resp['body'], true) ?: [];
  return [$resp, $data];
}</pre>
        </div>

        <h3>3. ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒ»ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–¢æ•°</h3>
        <p class="file-path">app/services/token_manager.php (17-102è¡Œç›®)</p>
        <div class="code-block">
<pre>function get_google_access_token_or_refresh($storage, array $config, int $userId, int $skewSeconds = 300): string
{
  $tokRow = $storage->getToken($userId);
  if (!$tokRow) {
    throw new RuntimeException('No token. Please login again.');
  }

  // å¾©å·
  $accessEnc = $tokRow['access_token_enc'] ?? '';
  if ($accessEnc === '') {
    throw new RuntimeException('Token is broken (missing access token). Please login again.');
  }
  $access = decrypt_str($accessEnc, $config['APP_KEY']);

  $refresh = null;
  if (!empty($tokRow['refresh_token_enc'])) {
    $refresh = decrypt_str($tokRow['refresh_token_enc'], $config['APP_KEY']);
  }

  // expires_at åˆ¤å®š
  $expiresAtStr = $tokRow['expires_at'] ?? '';
  $expiresAt = $expiresAtStr !== '' ? strtotime($expiresAtStr) : 0;
  $now = time();
  $needsRefresh = ($expiresAt <= 0) || ($expiresAt - $now <= $skewSeconds);

  if (!$needsRefresh) {
    return $access;
  }

  // refresh_token ãŒç„¡ã„å ´åˆã¯å†èªè¨¼ãŒå¿…è¦
  if (!$refresh) {
    throw new RuntimeException('Refresh token is missing. Please login again.');
  }

  // refresh å®Ÿè¡Œ
  [$resp, $data] = google_refresh_token($config, $refresh);
  $code = (int)($resp['code'] ?? 0);

  if ($code !== 200 || empty($data['access_token'])) {
    error_log('Refresh failed: HTTP ' . $code . ' body=' . ($resp['body'] ?? ''));
    throw new RuntimeException('Token refresh failed. Please login again.');
  }

  $newAccess = $data['access_token'];
  $expiresIn = (int)($data['expires_in'] ?? 3500);
  $newRefresh = $refresh;

  // ä¿å­˜ï¼ˆæš—å·åŒ–ï¼‰
  $tokenRow = [
    'access_token_enc' => encrypt_str($newAccess, $config['APP_KEY']),
    'refresh_token_enc' => $newRefresh ? encrypt_str($newRefresh, $config['APP_KEY']) : null,
    'expires_at' => date('Y-m-d H:i:s', $now + $expiresIn),
    'scopes' => $tokRow['scopes'] ?? ($config['GMAIL_SCOPE'] ?? ''),
  ];
  $storage->saveToken($userId, $tokenRow);

  return $newAccess;
}</pre>
        </div>

        <h3>4. OAuthèªè¨¼URLç”Ÿæˆ</h3>
        <p class="file-path">app/services/google_oauth.php (111-145è¡Œç›®)</p>
        <div class="code-block">
<pre>function google_auth_url($config, $state) {
  $scopes = trim($config['GOOGLE_SCOPES'] . ' ' . $config['GMAIL_SCOPE']);

  $params = array(
    'client_id' => $config['GOOGLE_CLIENT_ID'],
    'redirect_uri' => $config['GOOGLE_REDIRECT_URI'],
    'response_type' => 'code',
    'scope' => $scopes,
    'access_type' => 'offline',
    'prompt' => 'consent',
    'state' => $state,
  );

  // ã‚¯ã‚¨ãƒªçµ„ã¿ç«‹ã¦
  $pairs = array();
  foreach ($params as $k => $v) {
    if ($v === null) continue;
    $pairs[] = rawurlencode($k) . '=' . rawurlencode($v);
  }
  $q = implode('&', $pairs);

  $url = 'https://accounts.google.com/o/oauth2/v2/auth?' . $q;
  
  return $url;
}</pre>
        </div>

        <h3>5. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«</h3>
        <p class="file-path">config/config.php (26-31è¡Œç›®)</p>
        <div class="code-block">
<pre>'GOOGLE_CLIENT_ID' => isset($secrets['GOOGLE_CLIENT_ID']) ? $secrets['GOOGLE_CLIENT_ID'] : (getenv('GOOGLE_CLIENT_ID') ?: 'DUMMY_CLIENT_ID'),
'GOOGLE_CLIENT_SECRET' => isset($secrets['GOOGLE_CLIENT_SECRET']) ? $secrets['GOOGLE_CLIENT_SECRET'] : (getenv('GOOGLE_CLIENT_SECRET') ?: 'DUMMY_CLIENT_SECRET'),
'GOOGLE_REDIRECT_URI' => 'https://resend.kimito-link.com/auth/callback',

'GOOGLE_SCOPES' => 'openid email profile',
'GMAIL_SCOPE' => 'https://www.googleapis.com/auth/gmail.send',</pre>
        </div>

        <h3>6. ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜æ™‚ã®ã‚¹ã‚³ãƒ¼ãƒ—</h3>
        <p class="file-path">public/index.php (787-794è¡Œç›®)</p>
        <div class="code-block">
<pre>// 7) tokenä¿å­˜
$tokenRow = [
  'access_token_enc' => encrypt_str($access, $config['APP_KEY']),
  'refresh_token_enc' => $refresh ? encrypt_str($refresh, $config['APP_KEY']) : null,
  'expires_at' => date('Y-m-d H:i:s', time() + $expiresIn),
  'scopes' => $config['GMAIL_SCOPE'],  // â† ã“ã“ã§GMAIL_SCOPEã®ã¿ä¿å­˜
];
$storage->saveToken($userId, $tokenRow);</pre>
        </div>

        <h2>ğŸ¤” è€ƒãˆã‚‰ã‚Œã‚‹åŸå› </h2>
        <ol>
            <li><strong>OAuthã‚¹ã‚³ãƒ¼ãƒ—ã®å•é¡Œ</strong>
                <ul>
                    <li>ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«è¦æ±‚ã—ãŸã‚¹ã‚³ãƒ¼ãƒ—ã¨ã€å®Ÿéš›ã«ãƒˆãƒ¼ã‚¯ãƒ³ã«å«ã¾ã‚Œã‚‹ã‚¹ã‚³ãƒ¼ãƒ—ãŒä¸€è‡´ã—ã¦ã„ãªã„å¯èƒ½æ€§</li>
                    <li>ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜æ™‚ã« <code>$config['GMAIL_SCOPE']</code> ã®ã¿ã‚’ä¿å­˜ã—ã¦ã„ã‚‹ãŒã€å®Ÿéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¯è¤‡æ•°ã‚¹ã‚³ãƒ¼ãƒ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§</li>
                </ul>
            </li>
            <li><strong>Google Cloud Consoleã®è¨­å®šå•é¡Œ</strong>
                <ul>
                    <li>OAuthåŒæ„ç”»é¢ã§ <code>https://www.googleapis.com/auth/gmail.send</code> ã‚¹ã‚³ãƒ¼ãƒ—ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„</li>
                    <li>ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¦ã„ãªã„ï¼ˆãƒ†ã‚¹ãƒˆçŠ¶æ…‹ã®å ´åˆï¼‰</li>
                    <li>Gmail APIãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„</li>
                </ul>
            </li>
            <li><strong>ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¹ã‚³ãƒ¼ãƒ—ä¸ä¸€è‡´</strong>
                <ul>
                    <li>ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¨ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ™‚ã«è¦æ±‚ã—ã¦ã„ã‚‹ã‚¹ã‚³ãƒ¼ãƒ—ãŒç•°ãªã‚‹</li>
                    <li>ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ™‚ã«å…ƒã®ã‚¹ã‚³ãƒ¼ãƒ—ãŒå¤±ã‚ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§</li>
                </ul>
            </li>
            <li><strong>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§</strong>
                <ul>
                    <li>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯å–å¾—ã§ãã¦ã„ã‚‹ãŒã€Gmailé€ä¿¡æ¨©é™ãŒå«ã¾ã‚Œã¦ã„ãªã„</li>
                    <li>ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ‰åŠ¹ã ãŒã€Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆå´ã§æ¨©é™ãŒå–ã‚Šæ¶ˆã•ã‚Œã¦ã„ã‚‹</li>
                </ul>
            </li>
        </ol>

        <h2>ğŸ”§ ç¢ºèªã™ã¹ããƒã‚¤ãƒ³ãƒˆ</h2>
        <ol>
            <li><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®tokensãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª</strong>
                <ul>
                    <li><code>scopes</code>ã‚«ãƒ©ãƒ ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€¤</li>
                    <li>å®Ÿéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«å«ã¾ã‚Œã‚‹ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ç¢ºèªï¼‰</li>
                </ul>
            </li>
            <li><strong>Google Cloud Consoleã®è¨­å®šç¢ºèª</strong>
                <ul>
                    <li>OAuthåŒæ„ç”»é¢ã§ <code>https://www.googleapis.com/auth/gmail.send</code> ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹</li>
                    <li>Gmail APIãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹</li>
                    <li>ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹</li>
                </ul>
            </li>
            <li><strong>ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã‚¹ã‚³ãƒ¼ãƒ—è¦æ±‚ã‚’ç¢ºèª</strong>
                <ul>
                    <li><code>google_auth_url()</code> ã§ç”Ÿæˆã•ã‚Œã‚‹URLã«æ­£ã—ã„ã‚¹ã‚³ãƒ¼ãƒ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹</li>
                    <li>Googleèªè¨¼ç”»é¢ã§å®Ÿéš›ã«è¦æ±‚ã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚³ãƒ¼ãƒ—</li>
                </ul>
            </li>
            <li><strong>Gmail APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’ç¢ºèª</strong>
                <ul>
                    <li>403ã‚¨ãƒ©ãƒ¼æ™‚ã®è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ<code>$sResp['body']</code>ï¼‰</li>
                    <li>Google APIã‹ã‚‰ã®å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ç†ç”±</li>
                </ul>
            </li>
        </ol>

        <h2>ğŸ’¡ è³ªå•äº‹é …</h2>
        <ol>
            <li>403ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å‰ã«ã€æ­£å¸¸ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã§ãã¦ã„ãŸæœŸé–“ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ</li>
            <li>Google Cloud Consoleã®OAuthåŒæ„ç”»é¢ã§ã€<code>https://www.googleapis.com/auth/gmail.send</code> ã‚¹ã‚³ãƒ¼ãƒ—ã¯è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ</li>
            <li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã® <code>tokens</code> ãƒ†ãƒ¼ãƒ–ãƒ«ã® <code>scopes</code> ã‚«ãƒ©ãƒ ã«ã¯ä½•ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ</li>
            <li>ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«Googleèªè¨¼ç”»é¢ã§ã€ã©ã®ã‚¹ã‚³ãƒ¼ãƒ—ã®æ‰¿èªã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã—ãŸã‹ï¼Ÿ</li>
            <li>Gmail APIã®403ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ï¼ˆ<code>$sResp['body']</code>ï¼‰ã¯ç¢ºèªã§ãã¾ã™ã‹ï¼Ÿ</li>
            <li>å†ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦ã—ã¾ã—ãŸã‹ï¼Ÿãã®çµæœã¯ã©ã†ã§ã—ãŸã‹ï¼Ÿ</li>
        </ol>

        <h2>ğŸ“ è£œè¶³æƒ…å ±</h2>
        <div class="info-box">
            <p><strong>ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜æ™‚ã®å•é¡Œç‚¹:</strong></p>
            <p>ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ï¼ˆ<code>public/index.php</code> 792è¡Œç›®ï¼‰ã§ã€<code>'scopes' => $config['GMAIL_SCOPE']</code> ã¨ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¯è¤‡æ•°ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆ<code>openid email profile https://www.googleapis.com/auth/gmail.send</code>ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
            <p>ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ™‚ï¼ˆ<code>token_manager.php</code> 97è¡Œç›®ï¼‰ã§ã¯ã€<code>'scopes' => $tokRow['scopes'] ?? ($config['GMAIL_SCOPE'] ?? '')</code> ã¨ã—ã¦ã„ã‚‹ãŸã‚ã€ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚³ãƒ¼ãƒ—ãŒæ­£ã—ããªã„å ´åˆã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚‚å½±éŸ¿ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
        </div>

        <h2>ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹è§£æ±ºæ–¹æ³•</h2>
        <ol>
            <li>ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã®å®Ÿéš›ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç¢ºèªã—ã€ãã‚Œã‚’æ­£ã—ãä¿å­˜ã™ã‚‹</li>
            <li>Google Cloud Consoleã®è¨­å®šã‚’ç¢ºèªã—ã€å¿…è¦ãªã‚¹ã‚³ãƒ¼ãƒ—ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª</li>
            <li>å†ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦ã—ã¦ã€æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã§å‹•ä½œã™ã‚‹ã‹ç¢ºèª</li>
            <li>Gmail APIã®403ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèªã—ã¦ã€å…·ä½“çš„ãªåŸå› ã‚’ç‰¹å®š</li>
        </ol>

        <button class="copy-btn" onclick="copyToClipboard()">ğŸ“‹ ã“ã®ãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>

    <script>
        function copyToClipboard() {
            const text = document.body.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
            });
        }
    </script>
</body>
</html>
