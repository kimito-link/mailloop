# 再ログインによる権限の再取得と送信テスト手順

このドキュメントでは、Gmail送信権限を確実に取得するための再認証手順と、送信機能のテスト手順を説明します。

## 背景

`gmail_send.php`の修正により、宛先が連想配列（`email`キーを持つ形式）であっても正しくメールアドレスを抽出できるようになりました。しかし、既存のアクセストークンにGmail送信スコープ（`https://www.googleapis.com/auth/gmail.send`）が含まれていない場合、403エラーが発生する可能性があります。

そのため、一度ログアウトして再ログインすることで、最新の権限（Gmail送信）を確実に取得する必要があります。

## 手順

### 1. ログアウト

現在ログインしている場合は、以下のいずれかの方法でログアウトしてください：

#### 方法A: UIからログアウト
1. ブラウザでアプリケーションにアクセス
2. ヘッダー右上の「ログアウト」ボタンをクリック
3. ログイン画面にリダイレクトされることを確認

#### 方法B: 直接ログアウトURLにアクセス
```
https://your-domain.com/auth/logout
```

### 2. 再認証（Gmail送信権限を含む）

ログアウト後、以下のURLで再認証を行います：

```
https://your-domain.com/auth/login?reauth=1
```

**重要**: `?reauth=1`パラメータを付けることで、Google OAuth認証画面で再度権限の承認を求められます。これにより、Gmail送信スコープを含む最新のアクセストークンとリフレッシュトークンが取得されます。

#### 再認証時の確認事項

1. Google認証画面で、以下の権限が表示されることを確認：
   - メールアドレスの確認
   - Gmail送信権限（`https://www.googleapis.com/auth/gmail.send`）

2. 「許可」をクリックして認証を完了

3. 認証後、アプリケーションの送信画面（`/send`）にリダイレクトされることを確認

### 3. 送信テストの実行

再認証後、以下の手順で送信機能をテストします：

#### 3-1. テンプレートと宛先グループの準備

1. **テンプレートの作成/選択**
   - `/templates`にアクセス
   - 既存のテンプレートを選択するか、新しいテンプレートを作成
   - 件名と本文を設定

2. **宛先グループの作成/選択**
   - `/groups`にアクセス
   - 既存のグループを選択するか、新しいグループを作成
   - To/CC/BCCにメールアドレスを設定

#### 3-2. テスト送信の実行

1. **送信準備画面で設定**
   - `/send`にアクセス
   - テンプレートを選択（URLパラメータで指定されている場合は自動選択）
   - 宛先グループを選択
   - 件名と本文を確認・編集
   - 「確認へ」ボタンをクリック

2. **送信確認画面でテスト送信**
   - 送信確認画面（`/send/confirm`）が表示される
   - 宛先件数、件名、本文プレビューを確認
   - **「テスト送信（自分宛）」ボタンをクリック**
     - このボタンは、選択した宛先グループに関係なく、自分のメールアドレスに送信されます
     - 送信モードは`mode=test`として処理されます

3. **送信結果の確認**
   - 送信後、ログ詳細画面（`/logs/view`）にリダイレクトされます
   - 送信ステータスが「success」であることを確認
   - 自分のメールボックスにメールが届いていることを確認

#### 3-3. 本番送信の実行（オプション）

テスト送信が成功したら、本番送信も実行できます：

1. 送信確認画面に戻る（または再度送信準備画面から進む）
2. **「送信する」ボタンをクリック**
   - 確認ダイアログが表示される
   - 「OK」をクリックして送信を実行
3. 送信結果を確認

## トラブルシューティング

### 403エラー（権限不足）が発生する場合

送信時に403エラーが発生した場合、以下のメッセージが表示されます：

```
Gmail送信権限が不足しています。再ログインして権限を承認してください。
```

この場合、以下の手順を実行してください：

1. ログアウト（手順1を参照）
2. `/auth/login?reauth=1`で再認証（手順2を参照）
3. Google認証画面で、**必ず「許可」をクリック**してGmail送信権限を承認
4. 再度送信テストを実行

### トークンスコープの確認

再認証後、トークンにGmail送信スコープが含まれているか確認するには：

1. ブラウザの開発者ツールでネットワークタブを開く
2. `/send/execute`へのリクエストを確認
3. サーバーログで以下のメッセージを確認：
   ```
   Token scope check OK: gmail.send scope found. token_preview=... | user_id=...
   ```

### ログの確認

送信ログは`/logs`で確認できます：

1. `/logs`にアクセス
2. 送信試行の一覧を確認
3. 各ログの詳細（`/logs/view?id=<log_id>`）で以下を確認：
   - 送信ステータス（success/failed）
   - エラー情報（403エラーの場合は詳細が記録されます）
   - 送信先の件数

## 技術的な詳細

### 再認証の実装

- `/auth/login?reauth=1`にアクセスすると、`google_auth_url()`関数に`forceReauth=true`が渡されます
- `google_auth_url()`関数は、`prompt=consent`パラメータを含むOAuth認証URLを生成します
- これにより、Google認証画面で再度権限の承認を求められます

### テスト送信の実装

- 送信確認画面で「テスト送信（自分宛）」ボタンをクリックすると、`mode=test`が送信されます
- `/send/execute`ルートで`mode=test`の場合、宛先（To）が自分のメールアドレスに置き換えられます：
  ```php
  if($mode==='test'){ $to=[$u['email']]; $cc=[]; $bcc=[]; }
  ```

### スコープチェック

送信実行前に、トークンにGmail送信スコープが含まれているか確認します：

1. `google_tokeninfo()`関数でトークン情報を取得
2. `scope`パラメータに`https://www.googleapis.com/auth/gmail.send`が含まれているか確認
3. 含まれていない場合は、`/auth/login?reauth=1`にリダイレクト

## 関連ファイル

- `app/services/gmail_send.php` - メール送信処理（宛先抽出関数を含む）
- `app/services/google_oauth.php` - OAuth認証処理（`google_auth_url()`関数を含む）
- `public/index.php` - ルーティング（`/auth/login`, `/auth/logout`, `/send/execute`など）
- `views/send/confirm.php` - 送信確認画面（テスト送信ボタンを含む）

## まとめ

1. **ログアウト**: `/auth/logout`またはUIのログアウトボタン
2. **再認証**: `/auth/login?reauth=1`で再ログイン（`?reauth=1`を忘れずに）
3. **テスト送信**: 送信確認画面で「テスト送信（自分宛）」ボタンをクリック
4. **結果確認**: ログ画面とメールボックスで送信結果を確認

この手順により、Gmail送信権限が確実に取得され、送信機能が正常に動作することを確認できます。
