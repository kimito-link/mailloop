# 動作確認チェックリスト

## ✅ データベーステーブル作成確認

- [x] `oauth_tokens` テーブルが存在する
- [x] `message_templates` テーブルが存在する
- [x] `recipient_groups` テーブルが存在する
- [x] `send_logs` テーブルが存在する

**状態**: ✅ 完了（phpMyAdminで確認済み）

---

## 📋 機能テスト

### 1. テンプレート機能のテスト

#### 1-1. 空入力で保存を試みる
- [ ] `/templates/new` にアクセス
- [ ] すべてのフィールドを空のまま「保存」をクリック
- [ ] **期待結果**: エラーメッセージが表示され、入力内容が保持される

#### 1-2. 正常な入力で保存
- [ ] タイトル: `テストテンプレート`
- [ ] 件名: `テスト件名`
- [ ] 本文: `これはテスト本文です。`
- [ ] 「保存」をクリック
- [ ] **期待結果**: 保存成功、一覧画面に戻る
- [ ] phpMyAdminで `message_templates` テーブルを確認
- [ ] **期待結果**: 1行追加されている

#### 1-3. 文字数制限のテスト
- [ ] タイトル: 101文字以上を入力
- [ ] **期待結果**: エラー「タイトルは100文字以内です」
- [ ] 件名: 151文字以上を入力
- [ ] **期待結果**: エラー「件名は150文字以内です」
- [ ] 本文: 20,001文字以上を入力
- [ ] **期待結果**: エラー「本文は20,000文字以内です」

#### 1-4. CSRF対策のテスト
- [ ] ブラウザの開発者ツールでフォームの `csrf_token` を削除
- [ ] フォームを送信
- [ ] **期待結果**: 403エラー「不正なリクエストです。CSRFトークンが無効です。」

---

### 2. グループ機能のテスト

#### 2-1. 空入力で保存を試みる
- [ ] `/groups/new` にアクセス
- [ ] グループ名を空のまま「保存」をクリック
- [ ] **期待結果**: エラー「グループ名は必須です」

#### 2-2. メールアドレス0件で保存
- [ ] グループ名: `テストグループ`
- [ ] To/CC/BCCすべて空
- [ ] 「保存」をクリック
- [ ] **期待結果**: エラー「To/CC/BCCのいずれかに最低1件のメールアドレスが必要です」

#### 2-3. 正常な入力で保存
- [ ] グループ名: `テストグループ`
- [ ] To: `test1@example.com`
- [ ] CC: `test2@example.com`
- [ ] BCC: `test3@example.com`
- [ ] 「保存」をクリック
- [ ] **期待結果**: 保存成功、一覧画面に戻る
- [ ] phpMyAdminで `recipient_groups` テーブルを確認
- [ ] **期待結果**: 1行追加されている
- [ ] `to_json`, `cc_json`, `bcc_json` を確認
- [ ] **期待結果**: `[{"email":"test1@example.com","name":""}]` 形式で保存されている

#### 2-4. 100件上限のテスト
- [ ] グループ名: `100件テスト`
- [ ] To: 50件のメールアドレス（改行区切り）
- [ ] CC: 30件のメールアドレス
- [ ] BCC: 21件のメールアドレス（合計101件）
- [ ] 「保存」をクリック
- [ ] **期待結果**: エラー「To/CC/BCCの合計は100件以内です（現在: 101件）」

#### 2-5. 重複除去（dedupe）のテスト
- [ ] グループ名: `重複テスト`
- [ ] To: `test1@example.com`
- [ ] CC: `test1@example.com`（Toと同じ）
- [ ] BCC: `test2@example.com`
- [ ] 「保存」をクリック
- [ ] **期待結果**: 
  - 警告メッセージが黄色背景で表示される
  - 「test1@example.com が CC から外され To に統合されました」のようなメッセージ
  - 保存は成功する
- [ ] phpMyAdminで確認
- [ ] **期待結果**: Toに `test1@example.com` が1件、CCは空、BCCに `test2@example.com` が1件

#### 2-6. CSRF対策のテスト
- [ ] ブラウザの開発者ツールでフォームの `csrf_token` を削除
- [ ] フォームを送信
- [ ] **期待結果**: 403エラー「不正なリクエストです。CSRFトークンが無効です。」

---

### 3. エラーハンドリングのテスト

#### 3-1. DB接続エラーのテスト
- [ ] `config/secrets.php` の `DB_HOST` を `'invalid_host'` に変更
- [ ] `/templates/new` にアクセス
- [ ] **期待結果**: エラー画面が表示される（白画面ではない）
- [ ] `APP_DEBUG=true` の場合、詳細情報が表示される
- [ ] `APP_DEBUG=false` の場合、詳細情報は非表示
- [ ] 元に戻す: `DB_HOST` を `'localhost'` に戻す

#### 3-2. JSON encode失敗のテスト
- [ ] このテストは実装側で `json_encode()` が失敗するケースを想定
- [ ] 通常の運用では発生しにくいが、Storage実装で `RuntimeException` が投げられることを確認

---

### 4. セッション管理のテスト

#### 4-1. セッションIDの再生成確認
- [ ] ブラウザの開発者ツールでCookieを確認
- [ ] ログイン前の `mailloop_session` の値を記録
- [ ] ログイン処理を実行（現在はダミーユーザーなので、実際のログインはOAuth実装後）
- [ ] ログイン後の `mailloop_session` の値を確認
- [ ] **期待結果**: ログイン前後で値が変わっている（`session_regenerate_id(true)` が効いている）

#### 4-2. セッションタイムアウトのテスト
- [ ] ログイン状態で30分以上放置
- [ ] ページをリロードまたは別ページにアクセス
- [ ] **期待結果**: `/auth/login?timeout=1` にリダイレクトされる
- [ ] **注意**: 30分待つのは現実的ではないので、テスト時は `app/bootstrap.php` の `$ttl` を短く（例: 60秒）して確認

---

### 5. 追加チェック項目（GPT推奨）

#### 5-1. DBテーブル未作成時のエラー表示
- [ ] テーブルを一時的に削除（テスト用）
- [ ] `/templates/new` で保存を試みる
- [ ] **期待結果**: エラー画面が表示され、`error_log()` にログが出力される
- [ ] テーブルを復元

#### 5-2. ユーザー分離の確認
- [ ] 現在は `user_id=1` 固定だが、SQLが必ず `user_id` で絞れているか確認
- [ ] phpMyAdminで `SELECT * FROM message_templates WHERE user_id = 1;` を実行
- [ ] **期待結果**: 自分のテンプレートのみが表示される

#### 5-3. CSRFの二重送信耐性
- [ ] フォームを送信後、ブラウザの「戻る」ボタンで戻る
- [ ] 再度「保存」をクリック
- [ ] **期待結果**: 正常に処理される（エラーにならない）

---

## 🎯 テスト実行手順

1. **サーバー上で最新コードを取得**
   ```bash
   cd ~/kimito-link.com/_git/mailloop
   git pull origin main
   ```

2. **ブラウザでアクセス**
   - `https://resend.kimito-link.com/`
   - `https://resend.kimito-link.com/templates/new`
   - `https://resend.kimito-link.com/groups/new`

3. **各テスト項目を順番に実行**

4. **phpMyAdminでデータ確認**
   - `message_templates` テーブル
   - `recipient_groups` テーブル

---

## ✅ 完了判定

すべてのテスト項目が期待通りに動作すれば、**OAuth実装**に進む準備が整っています。

---

**作成日**: 2026年1月2日
**次のステップ**: 動作確認完了後 → OAuth実装
